version: 2

models:
  - name : stg_kobo_submission
    description: "Standardised Kobo submissions. Grain: 1 row per submission_id (deduped). Each record represents a single Kobo form submission after type casting, normalisation, and deduplication."
    config:
      tags: ['staging', 'wash', 'kobo']

    data_tests:
      - dbt_utils.expression_is_true:
          arguments:
            description: "Enforce submission contract: if a submission is marked as submitted, it must have a non-null submitted_at timestamp."
            expression: "(status <> 'submitted') OR (submitted_at IS NOT NULL)"
          config:
            severity: error
            store_failures: true
            where: "is_deleted = false" 

    columns:
      - name: submission_id
        description: "Primary business key for the submission. Identifies a single Kobo form submission and is the join key to other survey sections captured in the same submission."
        data_tests: 
          - not_null:
              config:
                severity: error
                store_failures: true

          - unique:
              config:
                severity: error
                store_failures: true
      
      - name: record_loaded_at
        description: "Ingestion/load timestamp for the record (lineage/audit). Used for deduplication ordering, freshness monitoring, and incremental processing."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: status
        description: "Normalised submission status from the source system (e.g., submitted vs draft). Used to determine whether submitted_at is required and to support operational reporting."
        data_tests:
          - accepted_values:
              arguments:
                values: ['submitted', 'draft']

              config:
                severity: error
                warn_if: "!= 0"
                error_if: "> 10"
                store_failures: true

  - name: stg_kobo_household
    description: "Standardised household section captured via Kobo. Grain: 1 row per household_id (deduped). Represents a single household record as reported within a submission."
    config:
      tags: ['staging', 'wash', 'kobo']

    data_tests:
      - dbt_utils.expression_is_true:
          arguments:
            description: "Validate household size falls within an expected range for reporting (strictly between 0 and 15)."
            expression: "hh_size_reported > 0 and hh_size_reported < 15"
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: "Primary business key for the household record. Identifier for a household as captured in the survey (used to join members and household-level attributes)."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true
          - unique:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: "Foreign key to stg_kobo_submission.submission_id. Links the household record back to the submission event in which it was captured."
        data_tests:
          - relationships:
              arguments:
                to: ref('stg_kobo_submission')
                field: submission_id
              config:
                severity: error
                store_failures: true
                where: "submission_id is not null and submission_id <> ''"

      - name: ward_id
        description: "Ward identifier reported for the household. Used for geographic aggregation and location-based analysis (e.g., ward-level WASH indicators)."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: water_filter_type
        description: "Reported household water treatment / filtration method used at home (normalised to a canonical set). Supports WASH indicator calculations and segmentation."
        data_tests:
          - accepted_values:
              arguments:
                values: 
                  - none
                  - boil
                  - candle
                  - chlorine
                  - sodis
                  - ceramic
                  - biosand
                  - cloth
                  - ro_uv
                  - other
                  - unknown
              config:
                severity: error
                store_failures: true

      - name: primary_water_source
        description: "Primary drinking water source category for the household (normalised to a canonical set). Used for WASH service-level classification and reporting."
        data_tests:
          - accepted_values:
              arguments:
                values: 
                  - piped_to_dwelling
                  - piped_to_yard_plot
                  - public_tap_standpipe
                  - tubewell_borehole
                  - protected_dug_well
                  - unprotected_dug_well
                  - protected_spring
                  - unprotected_spring
                  - rainwater
                  - tanker_truck_cart
                  - bottled_water
                  - surface_water
                  - spring
                  - tapstand
                  - other
                  - unknown
              config:
                severity: error
                store_failures: true

      - name: hh_size_reported
        description: "Reported household size (number of household members) as captured in the survey. Used for basic demographic context and validation."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

  - name: stg_kobo_member
    description: "Standardised household member repeat-group records captured via Kobo. Grain: 1 row per household_id and member_index (deduped). Represents one individual member within a household roster."
    config:
      tags: ['staging', 'wash', 'kobo']

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Ensure member grain is unique within a household by enforcing uniqueness on the (household_id, member_index) composite key."
            combination_of_columns:
              - household_id
              - member_index
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Validate member age is within a plausible human range for analysis (0 to 120 inclusive)."
            expression: "member_age_in_years >= 0 and member_age_in_years <= 120"
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: "Foreign key to stg_kobo_household.household_id. Identifies which household the member belongs to."
        data_tests: 
          - not_null:
              config:
                severity: error
                store_failures: true

          - relationships:
              arguments:
                to: ref('stg_kobo_household')
                field: household_id
              config:
                severity: error
                store_failures: true
                where: "household_id is not null and household_id <> ''"

      - name: submission_id
        description: "Foreign key to stg_kobo_submission.submission_id. Links the member record back to the submission event in which the roster was captured."
        data_tests:
          - not_null:
              config: 
                severity: error
                store_failures: true  

          - relationships:
              arguments:
                to: ref('stg_kobo_submission')
                field: submission_id
              config:
                severity: error
                store_failures: true
                where: "submission_id is not null and submission_id <> ''"

      - name: member_index
        description: "Repeat-group index for the member within the household roster. Together with household_id, defines the unique member record grain."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true   

      - name: member_sex
        description: "Reported sex/gender category for the household member, normalised to a canonical set (including unknown/other)."
        data_tests: 
          - accepted_values:
              arguments:
                values: 
                  - m
                  - f
                  - male
                  - female
                  - other
                  - unknown
              config:
                severity: error
                store_failures: true

  - name: stg_kobo_water_point
    description: "Standardised water point observation records captured via Kobo. Grain: 1 row per (water_point_id, submission_id) composite key (deduped). Represents a water point recorded/assessed during a submission."
    config:
      tags: ['staging', 'wash', 'kobo']

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce declared grain by ensuring uniqueness on the composite key (water_point_id, submission_id)."
            combination_of_columns:
              - water_point_id
              - submission_id
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Validate non-negative travel time to the water point in minutes. Distance/time should not be negative for reporting."
            expression: "distance_minutes is not null and distance_minutes >= 0"
          config:
            severity: error
            store_failures: true

    columns:
      - name: water_point_id
        description: "Business identifier for the water point as recorded in the survey. Used with submission_id to uniquely identify a water point observation."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: "Foreign key to stg_kobo_submission.submission_id. Links the water point observation back to the submission event in which it was recorded."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

          - relationships:
              arguments:
                to: ref('stg_kobo_submission')
                field: submission_id
              config:
                severity: error
                store_failures: true
                where: "submission_id is not null and submission_id <> ''"

      - name: ward_id
        description: "Ward identifier where the water point is located or reported. Supports ward-level aggregation and geographic analysis of WASH access."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: distance_minutes
        description: "Reported travel time or walking time to reach the water point, in minutes. Used for accessibility analysis and WASH service indicators."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: source_type
        description: "Categorised water source type for the water point (normalised to a canonical list). Used for water service classification and reporting."
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true
          
          - accepted_values:
              arguments:
                values:
                  - piped_to_dwelling
                  - piped_to_yard_plot
                  - public_tap_standpipe
                  - tubewell_borehole
                  - protected_dug_well
                  - unprotected_dug_well
                  - protected_spring
                  - unprotected_spring
                  - rainwater
                  - tanker_truck_cart
                  - bottled_water
                  - surface_water
                  - spring
                  - tapstand
                  - other
                  - unknown
              config:
                severity: error
                store_failures: true